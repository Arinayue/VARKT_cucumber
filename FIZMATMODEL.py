import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

# ======================================================
# 1. ЗАГРУЗКА ДАННЫХ KSP
# ======================================================
# t            — время (с)
# speed_ms     — модуль скорости (м/с)
# altitude_km  — высота (км)
# mass         — масса аппарата (кг)
df = pd.read_csv("Data.csv")
df = df[df["t"] <= 1827]

t_ksp = df["t"].values
v_ksp = df["speed_ms"].values
h_ksp = df["altitude_km"].values
m_ksp = df["mass"].values


# ======================================================
# 2. ВРЕМЕННАЯ СЕТКА МОДЕЛИ
# ======================================================
# Шаг по времени dt = 1 с
# Модель считается в дискретные моменты времени
dt = 1.0
t = np.arange(0, 1828, dt)
N = len(t)


# ======================================================
# 3. МАССИВЫ ФИЗМАТ-МОДЕЛИ
# ======================================================
# Все величины — функции времени

v = np.zeros(N)        # v(t) — модуль скорости, м/с
vx = np.zeros(N)       # vx(t) — горизонтальная компонента скорости, м/с
vy = np.zeros(N)       # vy(t) — вертикальная компонента скорости, м/с

h = np.zeros(N)        # h(t) — высота, км
x = np.zeros(N)        # x(t) — горизонтальное перемещение, км

m = np.zeros(N)        # m(t) — масса ракеты, кг
alpha = np.zeros(N)    # α(t) — угол траектории к горизонту, рад

g = np.zeros(N)        # g(h) — ускорение свободного падения, м/с²

# Физические константы
g0 = 9.81              # ускорение свободного падения у поверхности, м/с²
R  = 6.371e6           # радиус планеты (м)


# ======================================================
# 4. НАЧАЛЬНЫЕ УСЛОВИЯ (t = 0)
# ======================================================
v[0] = 0               # стартовая скорость
h[0] = 0.08            # стартовая высота 80 м
x[0] = 0               # стартовое горизонтальное смещение
m[0] = 53650           # стартовая масса ракеты
alpha[0] = np.pi / 2   # старт вертикально вверх (90°)

# Формула ускорения свободного падения:
# g(h) = g0 · (R / (R + h))²
g[0] = g0 * (R / (R + h[0]*1000))**2


# ======================================================
# 5. УСКОРЕНИЕ РАКЕТЫ (аппроксимация KSP)
# ======================================================
# a(t) — эффективное ускорение вдоль траектории
def acceleration(time):
    if time < 110:
        return 15        # активный разгон
    elif time < 240:
        return -1        # спад тяги
    elif time < 320:
        return 6         # повторный разгон
    elif time < 1794:
        return 0         # полёт без разгона
    else:
        return 22        # финальный импульс


# ======================================================
# 6. МОДЕЛЬ МАССЫ m(t)
# ======================================================
# Масса задаётся кусочно-линейной функцией времени
# Отражает:
# — работу ступеней
# — отделения
# — плато массы на орбите
def mass_model(time):
    if time < 118:
        return 53650 - (53650 - 16000) * (time / 118)
    elif time < 320:
        return 16000 - (16000 - 13000) * ((time - 118) / (320 - 118))
    elif time < 1798:
        return 13000
    elif time < 1827:
        return 13000 - (13000 - 3000) * ((time - 1798) / (1827 - 1798))
    else:
        return 3000


# ======================================================
# 7. ОСНОВНОЙ ФИЗМАТ-РАСЧЁТ (ПО ВРЕМЕНИ)
# ======================================================
# Здесь реализована дискретная форма уравнений движения

R = 600_000             # радиус Кербина (м)
g0 = 9.81
alpha_min = np.deg2rad(5)  # минимальный угол траектории

for i in range(N - 1):

    # --------------------------------------------------
    # 1) Скорость
    # v(t+dt) = v(t) + a(t) · dt
    v[i+1] = v[i] + acceleration(t[i]) * dt

    # --------------------------------------------------
    # 2) Гравитационный поворот
    # Угол α уменьшается со временем (переход к орбите)
    if t[i] < 1794:
        alpha[i+1] = max(alpha_min, alpha[i] - 0.0008)
    else:
        alpha[i+1] = alpha[i]

    # --------------------------------------------------
    # 3) Разложение скорости на компоненты
    # vx = v · cos(α)
    # vy = v · sin(α)
    vx[i+1] = v[i+1] * np.cos(alpha[i+1])
    vy[i+1] = v[i+1] * np.sin(alpha[i+1])

    # --------------------------------------------------
    # 4) Высота
    # h(t+dt) = h(t) + vy · dt
    # Ограничение: плато на 74 км
    h[i+1] = min(h[i] + vy[i+1] * dt / 1000, 74.0)

    # --------------------------------------------------
    # 5) Горизонтальное перемещение
    # x(t+dt) = x(t) + vx · dt
    x[i+1] = x[i] + vx[i+1] * dt / 1000

    # --------------------------------------------------
    # 6) Масса
    m[i+1] = mass_model(t[i])

    # --------------------------------------------------
    # 7) Ускорение свободного падения
    # g(h) = g0 · (R / (R + h))²
    g[i+1] = g0 * (R / (R + h[i]*1000))**2



# ВСЕ ГРАФИКИ ФИЗМАТ-МОДЕЛИ

fig1, axs1 = plt.subplots(3, 3, figsize=(18, 14))
axs1 = axs1.flatten()

axs1[0].plot(t, v);       axs1[0].set_title("v(t), м/с")
axs1[1].plot(t, m);       axs1[1].set_title("m(t), кг")
axs1[2].plot(t, g);       axs1[2].set_title("g(h), м/с²")
axs1[3].plot(t, h);       axs1[3].set_title("h(t), км")
axs1[4].plot(x, h);       axs1[4].set_title("Траектория x(h)")
axs1[5].plot(t, alpha);   axs1[5].set_title("α(t), рад")
axs1[6].plot(t, vx);      axs1[6].set_title("vx(t), м/с")
axs1[7].plot(t, vy);      axs1[7].set_title("vy(t), м/с")

for ax in axs1:
    ax.grid()

plt.tight_layout()
plt.show()



#ВСЕ ГРАФИКИ KSP

fig2, axs2 = plt.subplots(3, 1, figsize=(10, 10))

axs2[0].plot(t_ksp, v_ksp); axs2[0].set_title("KSP: v(t)")
axs2[1].plot(t_ksp, m_ksp); axs2[1].set_title("KSP: m(t)")
axs2[2].plot(t_ksp, h_ksp); axs2[2].set_title("KSP: h(t)")

for ax in axs2:
    ax.grid()

plt.tight_layout()
plt.show()



#СРАВНЕНИЕ ФИЗМАТ и KSP

fig3, axs3 = plt.subplots(3, 1, figsize=(10, 10))

axs3[0].plot(t, v, label="Физмат")
axs3[0].plot(t_ksp, v_ksp, label="KSP")
axs3[0].set_title("Скорость")
axs3[0].legend()

axs3[1].plot(t, m, label="Физмат")
axs3[1].plot(t_ksp, m_ksp, label="KSP")
axs3[1].set_title("Масса")
axs3[1].legend()

axs3[2].plot(t, h, label="Физмат")
axs3[2].plot(t_ksp, h_ksp, label="KSP")
axs3[2].set_title("Высота")
axs3[2].legend()

for ax in axs3:
    ax.grid()

plt.tight_layout()
plt.show()
